#include <cstring>
#include <filesystem>
#include <fstream>
#include <iostream>
#include <string>
#include <errno.h>
#include <sys/mount.h>

void WriteByMountBind(std::filesystem::path filepath, std::filesystem::path scratch_path)
{
    /*
       1. Get parent path of filepath
       2. Mount bind parent path from (1) to scratch path
       3. Access via scratch path
    */

    std::filesystem::path parent_path = filepath.parent_path();
    if(mount(parent_path.c_str(), scratch_path.c_str(), "", MS_BIND | MS_REC, "") != 0)
    {
        std::cerr << "error: " << strerror(errno) << "\n";
        return;
    }

    std::filesystem::path new_path = scratch_path / filepath.filename();

    std::ofstream t(new_path.c_str(), std::ios::binary);
    std::string data = "data to be written";
    t << data;
    t.close();

    if (umount(scratch_path.c_str()) != 0)
    {
        std::cerr << "error: " << strerror(errno) << "\n";
        return;
    }
}

int main(int argc, char** argv)
{
    std::filesystem::path filepath = "/home/user/.ssh/magic", scratch_path = "/tmp/foobar";
    WriteByMountBind(filepath, scratch_path);

    return 0;
}
