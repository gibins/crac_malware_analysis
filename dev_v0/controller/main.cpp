#include <iostream>
#include "../3rdparty/httplib.h"

int main()
{
    httplib::Client client("http://localhost:8080");

    std::string command;

    while(true)
    {
        std::cout << "prompt> " << std::flush;
        std::getline(std::cin, command);
        client.Post("/setcmd", command, "text/plain");

        auto response = client.Get("/getresponse");
        std::string output = response->body;
        bool isOutputCaptured = false;

        if (output.empty())
        {
            int timeout = 5;
            for (int i = 0; i < timeout; ++i)
            {
                sleep(1);
                response = client.Get("/getresponse");
                output = response->body;

                if (!output.empty())
                {
                    std::cout << output << std::endl;
                    isOutputCaptured = true;
                    break;
                }
            }
        }
        else
        {
            std::cout << output << std::endl;
            isOutputCaptured = true;
        }

        if (!isOutputCaptured)
            std::cout << "WARNING: output not captured" << std::endl;
    }

    return 0;
}